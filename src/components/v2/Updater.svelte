<script>
  import { quintOut } from "svelte/easing";
  import { scale } from "svelte/transition";
  import { onMount } from "svelte";
  import { check } from "@tauri-apps/plugin-updater";
  import { relaunch } from "@tauri-apps/plugin-process";
  import { isCheckingForUpdates, noriskLog } from "../../utils/noriskUtils.js";
  import { addNotification } from "../../stores/notificationStore.js";
  import { delay } from "../../utils/svelteUtils.js";

  let dots = "";

  onMount(async () => {
    let interval = animateLoadingText();

    // due to migration to tauri 2.0
    // const unlisten = await onUpdaterEvent(({ error, status }) => {
    //   // This will log all updater events, including status updates and errors.
    //   noriskLog(`Updater event: ${error} ${status}`);
    // });

    try {
      const update = await check();

      if (update?.available) {
        noriskLog(`Installing update: ${manifest?.version} ${manifest?.body}`);

        // Install the update. This will also restart the app on Windows!
        await update.downloadAndInstall().catch(reason => {
          addNotification(reason);
        });
        noriskLog(`Update was installed`);

        isCheckingForUpdates.set(false);

        noriskLog(`Trying to relaunch`);

        await relaunch().catch(reason => {
          addNotification(reason);
        });
      } else {
        //TODO das kann in production weg
        await delay(1000);
        isCheckingForUpdates.set(false);
      }
    } catch (error) {
      isCheckingForUpdates.set(false);
      addNotification(error);
    }

    return () => {
      clearInterval(interval);
      unlisten();
    };
  });

  function animateLoadingText() {
    return setInterval(function() {
      dots += " .";
      if (dots.length > 6) {
        dots = "";
      }
    }, 500);
  }
</script>


<h1 class="branch-font primary-text" style="position:absolute"
    transition:scale={{ x: 15, duration: 300, easing: quintOut }}>Searching Updates{dots}</h1>

<style>
    .branch-font {
        font-family: 'Press Start 2P', serif;
        font-size: 18px;
        margin: 0;
        cursor: default;
    }
</style>
